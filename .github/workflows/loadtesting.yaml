name: Load testing

on:
  workflow_dispatch:
  schedule:
    - cron: '30 4 * * *'
jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 4
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Run edge as a daemon
        run: |
          docker run --name edge -d -p 3063:3063 unleashorg/unleash-edge:edge edge
        env:
          UPSTREAM_URL: https://sandbox.getunleash.io/eg
          TOKENS: ${{ secrets.UNLEASH_CLIENT_SECRET }}
      - name: Run K6 client/features benchmark
        uses: grafana/k6-action@v0.2.0
        with:
          filename: benchmarks/clientfeaturesendpoint.js
        env:
          TOKEN: ${{ secrets.UNLEASH_CLIENT_SECRET }}
      - name: Run K6 proxy benchmark
        uses: grafana/k6-action@v0.2.0
        with:
          filename: benchmarks/proxyendpoint.js
        env:
          TOKEN: ${{ secrets.UNLEASH_FRONTEND_SECRET }}
      - name: Stop edge
        run: |
          docker stop edge