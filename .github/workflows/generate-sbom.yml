name: Generate sbom
permissions:
  contents: "write"

on:
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      tag:
        description: "Which tag to generate the sbom for?"
        type: "string"
        required: true

jobs:
  sbom:
    runs-on: "ubuntu-24.04"
    steps:
      - uses: actions/checkout@v5
        name: Checkout code
      - name: Install cargo-sbom
        run:
          cargo install cargo-sbom
      - name: Run sbom
        id: sbom
        shell: bash
        run: |
          set -euo pipefail
          OUTPUT="$(cargo sbom --output-format=cyclone_dx_json_1_6 --cargo-package unleash-edge)"
          {
            echo "report<<EOF"
            echo "$OUTPUT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
  attach-to-release:
    runs-on: ubuntu-latest
    needs: sbom
    steps:
      - uses: actions/checkout@v5
        name: Checkout code
      - name: Turn job output into a file
        shell: bash
        run: |
          mkdir -p out
          cat > out/unleash-edge-cyclone-dx.sbom.json <<'EOF'
          ${{ needs.sbom.outputs.report }}
          EOF
          ls -l out
      - name: Upload file to existing release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.inputs.tag }}"
          gh release upload "$TAG" out/unleash-edge-cyclone-dx.sbom.json --clobber